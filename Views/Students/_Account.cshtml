@model consultancysolution.Models.AccountDto
<div id="account" class="tab-pane" style="">
    <div class="admission-container">
        <partial name="_AdmissionInfo" model="Model.Admission" />
    </div>
    <div class="coursePayment-container">
        <partial name="_CoursePaymentInfo" model="Model.CoursePayments" />
    </div>
</div>
<script>
    //save admission fee
    function saveAdmissionFee(url) {
        const admissionFee = parseFloat($("#admissionFee").val()) || 0;
        const discount = parseFloat($("#admissionFeeDiscount").val()) || 0;
        const modifiedFee = parseFloat($("#modifiedAdmissionFee").text()) || 0;
        const paid = parseFloat($("#paidAdmissionAmount").val()) || 0;
        const due = parseFloat($("#dueAdmissionAmount").text()) || 0;

        const payload = {
            AdmissionFee: admissionFee,
            Discount: discount,
            ModifiedAdmissionFee: modifiedFee,
            Paid: paid,
            Due: due
        };

        $.ajax({
            url: url,
            type: 'POST',
            data: JSON.stringify(payload),
            contentType: 'application/json',
            success: function (response) {
                if (response.success) {
                    debugger;
                    $('.admission-container').html(response.html);
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: 'Success!',
                        text: response.message || 'Admission fee saved successfully.',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: response.message || 'Failed to save admission fee.'
                    });
                }
            },
            error: function () {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while saving admission fee.'
                });
            }
        });
    }
    $(document)
        .off('click', "#saveAdmissionFee, #updateAdmissionFee")
        .on('click', "#saveAdmissionFee, #updateAdmissionFee", function () {
            saveAdmissionFee(`/Students/SaveAdmissionFee?studentId=${$('#StudentID').val()}`);
        });
    $(document)
        .off('click', '#editAdmissionFee')
        .on('click', '#editAdmissionFee', function () {
            $("#admissionFee, #admissionFeeDiscount, #paidAdmissionAmount").prop("disabled", false);
            $("#updateAdmissionFee, #cancelAdmissionFee").show();
            $(this).hide();
        });

    $(document)
        .off('click', '#cancelAdmissionFee')
        .on('click', '#cancelAdmissionFee', function () {
            $('[data-tab="account"]').click();
        });
    //save course payments
    function submitCoursePayments(url) {
        debugger;
        const coursePayments = [];
        $("#coursePaymentTable tbody tr").each(function () {
            const row = $(this);
            const courseId = row.data("course-id");
            const price = parseFloat(row.find("td:nth-child(2)").text()) || 0;
            const paid = parseFloat(row.find(".paidAmount").val()) || 0;
            const due = Math.max(0, price - paid);

            // Update the UI values
            row.find(".dueAmount").text(due.toFixed(2));

            coursePayments.push({
                CourseId: courseId,
                Price: price,
                PaidAmount: paid,
                DueAmount: due
            });
        });
        $.ajax({
            url: url,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(coursePayments),
            success: function (response) {
                if (response.success) {
                    debugger;
                    $('.coursePayment-container').html(response.html);
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: 'Success!',
                        text: response.message || 'Course payments saved successfully.',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });
                }
            },
            error: function () {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while saving course payments.'
                });
            }
        });
    }
    $(document)
        .off('click', '#saveCoursePayments, #updateCoursePayments')
        .on('click', '#saveCoursePayments, #updateCoursePayments', function () {
            const saveUrl = `/Students/SaveCoursePayments?studentId=${$('#StudentID').val()}`;
            submitCoursePayments(saveUrl);
        });

    $(document)
        .off('click', '#editCoursePayments')
        .on("click", '#editCoursePayments', function () {
            $(".paidAmount").prop("disabled", false);
            $("#updateCoursePayments, #cancelCoursePayments").show();
            $(this).hide();
        });
    $(document)
        .off('click', '#cancelCoursePayments')
        .on("click", '#cancelCoursePayments', function () {
            $('[data-tab="account"]').click();
        });
</script>
