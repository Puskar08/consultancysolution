<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Student</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .step-nav {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .step-nav .step-button {
            flex: 1;
            margin: 0 5px;
            background-color: #e9ecef;
            border: none;
            padding: 12px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
        }

        .step-nav .step-button.active {
            background-color: #007bff;
            color: white;
        }

        .step-nav .step-button.disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
        }
    </style>
</head>
@{
    var editMode = ViewBag.EditMode;
}

<body>
    <div class="container mt-4">
        <!-- Nav Tabs -->
        <div class="step-nav" id="studentTabs">
            <button class="step-button active" data-tab="basic-info">Basic Info</button>
            <button class="step-button disabled" data-tab="course-selection">Course Selection</button>
            <button class="step-button disabled" data-tab="account">Account</button>
        </div>

        <!-- Tab Content -->
        <div class="tab-content mt-3">
            <!-- Basic Info -->
            <div id="basic-info" class="tab-pane active">
                <form id="studentForm">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>Name</label>
                            <input type="text" class="form-control" name="Name" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label>Email</label>
                            <input type="email" class="form-control" name="Email" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label>Phone</label>
                            <input type="text" class="form-control" name="Phone" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label>Address</label>
                            <input type="text" class="form-control" name="Address">
                        </div>
                        <div class="form-group col-md-6">
                            <label>Date of Birth</label>
                            <input type="date" class="form-control" name="DateOfBirth" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label>Admission Date</label>
                            <input type="date" class="form-control" name="AdmissionDate" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary float-right">Save</button>
                    <!-- Below the form in Basic Info tab -->
                    <button id="editBasicInfo" class="btn btn-warning float-right">Edit</button>
                    <button id="updateBasicInfo" class="btn btn-success float-right"
                        style="display:none;">Update</button>

                </form>
            </div>

            <!-- Course Selection -->
            <div id="course-selection" class="tab-pane" style="display:none">
                <div class="form-group">
                    <label>Select Courses:</label>
                    <select id="courseDropdown" class="form-control">
                        <option value="">-- Select Course --</option>
                        <option value="1" data-fee="5000">JavaScript</option>
                        <option value="2" data-fee="6000">Python</option>
                    </select>
                </div>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Course</th>
                            <th>Course Fee</th>
                            <th>Discount</th>
                            <th>Modified Fee</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="selectedCourses"></tbody>
                </table>
                <button id="saveCourses" class="btn btn-primary float-right">Save</button>
                <button id="editCourses" class="btn btn-warning float-right" style="display:none;">Edit</button>
                <button id="updateCourses" class="btn btn-success float-right" style="display:none;">Update</button>

            </div>

            <!-- Account -->
            <div id="account" class="tab-pane" style="display:none">
                <h5>Admission Fee</h5>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Admission Fee</th>
                            <th>Discount</th>
                            <th>Modified Fee</th>
                            <th>Paid</th>
                            <th>Due</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>₹5000</td>
                            <td>₹500</td>
                            <td>₹4500</td>
                            <td><input class="form-control" type="number" value="0"></td>
                            <td>₹4500</td>
                        </tr>
                    </tbody>
                </table>
                <button id="saveAdmissionFee" class="btn btn-success float-right mb-4">Save Admission Fee</button>
                <button id="editAdmissionFee" class="btn btn-warning float-right" style="display:none;">Edit Admission
                    Fee</button>
                <button id="updateAdmissionFee" class="btn btn-success float-right" style="display:none;">Update
                    Admission Fee</button>

                <h5>Course Payments</h5>
                <table class="table table-bordered" id="coursePaymentTable">
                    <thead>
                        <tr>
                            <th>Course</th>
                            <th>Modified Fee</th>
                            <th>Paid</th>
                            <th>Due</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button id="saveCoursePayments" class="btn btn-success float-right">Save Course Payments</button>
            </div>
        </div>
    </div>

    <!-- Popup messages -->
    <div id="popup" class="alert alert-success"
        style="display:none; position:fixed; top:20px; right:20px; z-index:9999"></div>

    <script>
        const studentCourses = [];
        let studentId = null;
        const editmode = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(editMode));
        function basicInfoInEditModeLoad() {
            $('#studentForm input').prop('disabled', true);
            $('#editBasicInfo').show();
            $('#updateBasicInfo').hide();
        }
        function courseSelectionInEditModeLoad() {
            $('#courseDropdown').prop('disabled', true);
            $('#saveCourses').hide();
            $('#editCourses').show();
            $('#updateCourses').hide();
        }
        function accountInEditModeLoad() {
            $('#saveAdmissionFee').hide();
            $('#saveCoursePayments').hide();
            $('#editCourses').show();
            $('#updateCourses').hide();
        }
        if (editmode == 'Create') {
            basicInfoInEditModeLoad();
            $('#updateBasicInfo').hide();
        } else {
            $('#editBasicInfo').show();
            $('#updateBasicInfo').hide();
        }
        $(document).ready(function () {
            $('.step-button').click(function (e) {
                const tab = $(this).data('tab');
                if ($(this).hasClass('disabled')) return;

                $('.step-button').removeClass('active');
                $(this).addClass('active');
                $('.tab-pane').hide();
                $('#' + tab).show();
            });
            // Disable inputs after Save
            function toggleBasicInfo(disabled) {
                $('#studentForm input').prop('disabled', disabled);
                $('#studentForm button[type="submit"]').toggle(!disabled);
                $('#editBasicInfo').toggle(disabled);
                $('#updateBasicInfo').toggle(false);
            }
            $('#studentForm').submit(function (e) {
                e.preventDefault();

                const formData = {
                    name: $('[name="Name"]').val(),
                    email: $('[name="Email"]').val(),
                    phone: $('[name="Phone"]').val(),
                    address: $('[name="Address"]').val(),
                    dateOfBirth: $('[name="DateOfBirth"]').val(),
                    admissionDate: $('[name="AdmissionDate"]').val()
                };

                $.ajax({
                    url: '/Students/CreateStudent',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        studentId = response.id;

                        $('#popup')
                            .removeClass('alert-danger')
                            .addClass('alert-success')
                            .text('Student saved successfully!')
                            .fadeIn().delay(2000).fadeOut();
                        toggleBasicInfo(true);
                        // Enable next tabs
                        $('[data-tab="course-selection"]').removeClass('disabled');
                        $('[data-tab="account"]').removeClass('disabled');
                        // Populate course dropdown
                        const dropdown = $('#courseDropdown');
                        dropdown.empty().append('<option value="">-- Select Course --</option>');
                        response.courses.forEach(course => {
                            dropdown.append(`<option value="${course.id}" data-fee="${course.fee}">${course.name}</option>`);
                        });
                        $('[data-tab="course-selection"]').click();
                    },
                    error: function (xhr) {
                        const response = xhr.responseJSON;
                        const errorText = response && response.errors ? response.errors.join(', ') : 'Failed to save student!';

                        $('#popup')
                            .removeClass('alert-success')
                            .addClass('alert-danger')
                            .text(errorText)
                            .fadeIn().delay(4000).fadeOut();
                    }
                });
            });
            // Edit button click
            $('#editBasicInfo').click(function () {
                $('#studentForm input').prop('disabled', false);
                $('#editBasicInfo').hide();
                $('#updateBasicInfo').show();
            });
            // Update button click
            $('#updateBasicInfo').click(function () {
                const updatedData = {
                    name: $('input[name="name"]').val(),
                    email: $('input[name="email"]').val(),
                    phone: $('input[name="phone"]').val(),
                    address: $('input[name="address"]').val(),
                    dob: $('input[name="DateOfBirth"]').val(),
                    admission_date: $('input[name="AdmissionDate"]').val()
                };
                // Simulate update call
                console.log("Updating student...", updatedData);
                $('#popup').text('Student info updated!').fadeIn().delay(2000).fadeOut();
                toggleBasicInfo(true);
            });

            $('#courseDropdown').change(function () {
                const selected = $(this).find(':selected');
                const name = selected.text();
                const id = selected.val();
                const fee = selected.data('fee');

                if (!id || studentCourses.find(c => c.id === id)) return;

                studentCourses.push({ id, name, fee, discount: 0, modifiedFee: fee });
                renderCourseTable();
            });

            function renderCourseTable() {
                const tbody = $('#selectedCourses');
                tbody.empty();
                studentCourses.forEach((c, i) => {
                    tbody.append(`
          <tr>
            <td>${c.name}</td>
            <td>${c.fee}</td>
            <td><input type='number' class='form-control discount' data-index='${i}' value='${c.discount}'></td>
            <td>${c.modifiedFee}</td>
            <td><button class='btn btn-danger btn-sm remove-course' data-id='${c.id}'>Remove</button></td>
          </tr>`);
                });
            }

            $(document).on('click', '.remove-course', function () {
                const id = $(this).data('id');
                const index = studentCourses.findIndex(c => c.id == id);
                if (index >= 0) studentCourses.splice(index, 1);
                renderCourseTable();
            });

            $(document).on('input', '.discount', function () {
                const index = $(this).data('index');
                const discount = parseFloat($(this).val()) || 0;
                studentCourses[index].discount = discount;
                studentCourses[index].modifiedFee = studentCourses[index].fee - discount;
                renderCourseTable();
            });
            function toggleCourseButtons(disabled) {
                $('#editCourses').toggle(disabled);
                $('#updateCourses').toggle(disabled);
            }
            $('#saveCourses').click(function () {
                if (!studentId || studentCourses.length === 0) return;

                const payload = studentCourses.map(c => ({
                    studentId: studentId,
                    courseId: parseInt(c.id),
                    modifiedFee: parseFloat(c.modifiedFee)
                }));

                $.ajax({
                    url: '/Students/SaveCourses',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function (response) {
                        if (response.courses && response.courses.length > 0) {
                            $('#editCourses').show();
                            renderSavedCourses(response.courses); // Populate account tab with saved data
                        }

                        $('#popup').text('Courses added successfully!').fadeIn().delay(2000).fadeOut();
                        $('[data-tab="account"]').removeClass('disabled').click();
                    },
                    error: function () {
                        $('#popup').removeClass('alert-success').addClass('alert-danger')
                            .text('Failed to save courses!').fadeIn().delay(3000).fadeOut();
                    }
                });
            });
            function renderSavedCourses(courses) {
                const tbody = $('#coursePaymentTable tbody');
                tbody.empty();

                courses.forEach(c => {
                    tbody.append(`
                            <tr>
                                <td>${c.name}</td>
                                <td>₹${c.modifiedFee}</td>
                                <td><input class='form-control' type='number' value='0'></td>
                                <td>₹${c.modifiedFee}</td>
                            </tr>
                        `);
                });
            }

            $('#saveAdmissionFee').click(function () {
                const paid = parseFloat($('#account tbody tr:eq(0) td input').val()) || 0;
                const modifiedFee = 4500; // This should be dynamically calculated or stored if you support discounts
                const due = modifiedFee - paid;

                $.ajax({
                    url: '/Students/SaveAdmissionFee',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        studentId: studentId,
                        admissionFee: modifiedFee,
                        paid: paid,
                        due: due
                    }),
                    success: function () {
                        $('#popup').text('Admission fee saved successfully!').fadeIn().delay(2000).fadeOut();
                    },
                    error: function () {
                        $('#popup').removeClass('alert-success').addClass('alert-danger').text('Failed to save admission fee!').fadeIn().delay(3000).fadeOut();
                    }
                });
            });
            $('#saveCoursePayments').click(function () {
                const paymentData = [];

                $('#coursePaymentTable tbody tr').each(function (index) {
                    const course = studentCourses[index];
                    const paidInput = $(this).find('input').val();
                    const paid = parseFloat(paidInput) || 0;
                    const due = course.modifiedFee - paid;

                    paymentData.push({
                        studentId: studentId,
                        courseId: course.id,
                        paidAmount: paid,
                        dueAmount: due
                    });
                });

                $.ajax({
                    url: '/Students/SaveCoursePayments',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(paymentData),
                    success: function () {
                        $('#popup')
                            .text('Course payments saved successfully!')
                            .removeClass('alert-danger')
                            .addClass('alert-success')
                            .fadeIn().delay(2000).fadeOut();
                    },
                    error: function () {
                        $('#popup')
                            .text('Failed to save course payments!')
                            .removeClass('alert-success')
                            .addClass('alert-danger')
                            .fadeIn().delay(3000).fadeOut();
                    }
                });
            });


            function populatePaymentTable() {
                const tbody = $('#coursePaymentTable tbody');
                tbody.empty();
                studentCourses.forEach(c => {
                    tbody.append(`
          <tr>
            <td>${c.name}</td>
            <td>₹${c.modifiedFee}</td>
            <td><input class='form-control' type='number' value='0'></td>
            <td>₹${c.modifiedFee}</td>
          </tr>
        `);
                });
            }
        });
    </script>
</body>

</html>
